# 第3节：正则表达式

## 学习目标

- **<font color="red">掌握正则表达式的基本语法</font>**
- **<font color="blue">学习数据提取的核心方法</font>**
- **<font color="green">理解数据验证的应用场景</font>**
- **<font color="purple">熟练使用match函数、search函数和findAll方法</font>**
- **<font color="orange">掌握split函数处理字符串分割的技巧</font>**

## 知识点

### 正则表达式基础

- **<font color="red">定义</font>**：用于描述字符串模式的特殊字符序列
- **<font color="blue">作用</font>**：字符串匹配、提取、替换和验证
- **<font color="green">Python实现</font>**：内置`re`模块

### 元字符

- **<font color="red">字符匹配</font>**：
  - `.` - 匹配除换行符外的任意字符
  - `\d` - 匹配数字
  - `\D` - 匹配非数字
  - `\w` - 匹配字母、数字、下划线
  - `\W` - 匹配非字母、数字、下划线
  - `\s` - 匹配空白字符
  - `\S` - 匹配非空白字符

- **<font color="blue">边界匹配</font>**：
  - `^` - 匹配字符串开头
  - `$` - 匹配字符串结尾
  - `\b` - 匹配单词边界
  - `\B` - 匹配非单词边界

- **<font color="green">数量限定</font>**：
  - `*` - 匹配0次或多次
  - `+` - 匹配1次或多次
  - `?` - 匹配0次或1次
  - `{n}` - 匹配恰好n次
  - `{n,}` - 匹配至少n次
  - `{n,m}` - 匹配n到m次

- **<font color="purple">字符集</font>**：
  - `[abc]` - 匹配a、b或c
  - `[^abc]` - 匹配除a、b、c外的任意字符
  - `[a-z]` - 匹配所有小写字母
  - `[A-Z]` - 匹配所有大写字母
  - `[0-9]` - 匹配所有数字

- **<font color="orange">分组与引用</font>**：
  - `()` - 分组
  - `\1, \2` - 引用分组
  - `(?:...)` - 非捕获分组

### 核心函数

- **<font color="red">re.match()</font>**：
  - 从字符串开头匹配模式
  - 成功返回Match对象，失败返回None

- **<font color="blue">re.search()</font>**：
  - 在整个字符串中搜索第一个匹配
  - 成功返回Match对象，失败返回None

- **<font color="green">re.findall()</font>**：
  - 返回所有匹配的字符串列表

- **<font color="purple">re.finditer()</font>**：
  - 返回匹配对象的迭代器

- **<font color="orange">re.split()</font>**：
  - 使用正则表达式分割字符串

- **<font color="red">re.sub()</font>**：
  - 替换匹配的子字符串

### 正则表达式标志

- **<font color="blue">re.I</font>**：忽略大小写
- **<font color="green">re.M</font>**：多行模式
- **<font color="purple">re.S</font>**：点号匹配所有字符，包括换行符
- **<font color="orange">re.X</font>**：忽略正则表达式中的空白和注释

## 典型示例

### 基本匹配

```python
import re

# 匹配数字
text = "我的电话号码是13812345678，他的电话是13987654321"
pattern = r"1\d{10}"  # 匹配1开头的11位数字

# 使用findall查找所有匹配
result = re.findall(pattern, text)
print(f"找到的电话号码: {result}")
```

### 分组提取

```python
import re

# 提取年月日
text = "今天是2023-05-15，明天是2023-05-16"
pattern = r"(\d{4})-(\d{2})-(\d{2})"

# 使用findall提取分组
result = re.findall(pattern, text)
print(f"提取的日期: {result}")

# 使用search提取单个日期的分组
match = re.search(pattern, text)
if match:
    year, month, day = match.groups()
    print(f"年: {year}, 月: {month}, 日: {day}")
```

### match与search的区别

```python
import re

text = "Python是一种编程语言，Python很简单"

# 使用match从开头匹配
match_result = re.match(r"Python", text)
print(f"match结果: {match_result.group() if match_result else None}")

# 使用match匹配中间内容
match_result2 = re.match(r"编程", text)
print(f"match结果2: {match_result2.group() if match_result2 else None}")

# 使用search在任意位置匹配
search_result = re.search(r"编程", text)
print(f"search结果: {search_result.group() if search_result else None}")
```

### 使用split分割字符串

```python
import re

# 使用多种分隔符分割字符串
text = "Python,Java;C++:JavaScript"
result = re.split(r"[,;:]", text)
print(f"分割结果: {result}")

# 限制分割次数
result_limited = re.split(r"[,;:]", text, maxsplit=2)
print(f"限制分割次数结果: {result_limited}")
```

### 使用sub替换文本

```python
import re

# 替换敏感词
text = "这个产品很垃圾，服务也很差劲"
result = re.sub(r"垃圾|差劲", "**", text)
print(f"替换结果: {result}")

# 使用函数进行复杂替换
def convert_date(match):
    # 将YYYY-MM-DD转换为MM/DD/YYYY
    year, month, day = match.groups()
    return f"{month}/{day}/{year}"

text = "日期格式：2023-05-15和2023-06-20"
result = re.sub(r"(\d{4})-(\d{2})-(\d{2})", convert_date, text)
print(f"日期格式转换: {result}")
```

## 实际示例

### 提取网页中的邮箱地址

```python
import re
import requests

# 获取网页内容
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
}
response = requests.get('http://example.com', headers=headers)
html = response.text

# 定义邮箱正则表达式
email_pattern = r'[\w\.-]+@[\w\.-]+\.\w+'

# 提取所有邮箱
emails = re.findall(email_pattern, html)

# 去重并打印结果
unique_emails = list(set(emails))
print(f"找到{len(unique_emails)}个邮箱地址:")
for email in unique_emails:
    print(email)
```

### 提取新闻标题和链接

```python
import re
import requests

# 获取新闻页面
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
}
response = requests.get('https://news.example.com', headers=headers)
html = response.text

# 提取新闻标题和链接
# 假设HTML结构为: <a href="链接">标题</a>
pattern = r'<a[^>]*href="([^"]*)"[^>]*>([^<]*)</a>'

# 查找所有匹配
matches = re.findall(pattern, html)

# 打印结果
print(f"找到{len(matches)}条新闻:")
for link, title in matches[:10]:  # 只显示前10条
    print(f"标题: {title.strip()}")
    print(f"链接: {link}")
    print("-" * 50)
```

## 思考题

1. 如何编写正则表达式来验证中国手机号码的格式？
2. 贪婪匹配和非贪婪匹配有什么区别？如何在正则表达式中实现非贪婪匹配？
3. 如何使用正则表达式提取HTML中的所有图片URL？
4. 正则表达式和BeautifulSoup等解析库相比，各有什么优缺点？
5. 如何优化复杂正则表达式的性能？
  
## 小结

- **<font color="red">正则表达式是处理文本的强大工具，尤其适合模式匹配和数据提取</font>**
- **<font color="blue">掌握元字符、量词和分组是使用正则表达式的基础</font>**
- **<font color="green">match函数从字符串开头匹配，search函数在整个字符串中搜索</font>**
- **<font color="purple">findall函数返回所有匹配项，适合批量数据提取</font>**
- **<font color="orange">split和sub函数提供了字符串分割和替换的强大功能</font>**

## 总结

正则表达式是爬虫开发中不可或缺的工具，它提供了强大的文本处理能力。本节课介绍了正则表达式的基本语法、常用函数和实际应用场景。通过掌握这些知识，我们可以从网页中精确提取所需的数据，处理各种格式的文本信息。虽然正则表达式的语法看起来复杂，但通过不断练习和实践，可以逐步提高使用熟练度。在实际爬虫开发中，正则表达式通常与其他工具（如BeautifulSoup）结合使用，以实现更高效、更准确的数据提取。