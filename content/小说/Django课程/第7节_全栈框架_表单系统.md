---
title: "第7节_全栈框架_表单系统"
slug: "第7节_全栈框架_表单系统"
date: "2025-05-19T12:20:42.386087+00:00"
---

# 第7节：全栈框架_表单系统

## 来源

表单系统是Django框架中处理用户输入的重要组件。在Web应用程序中，表单是用户与应用程序交互的主要方式，用于收集用户输入并进行处理。Django的表单系统设计精巧而强大，提供了表单生成、数据验证、错误处理等功能，大大简化了表单处理的复杂性。Django表单系统与模型层紧密集成，支持从模型自动生成表单，实现了数据验证与业务逻辑的分离，提高了代码的可维护性和可重用性。

## 定义

### 表单系统的概念

表单系统是Web应用程序中负责处理用户输入的组件。在Django中，表单系统由以下部分组成：

1. **Form类**：定义表单字段、验证规则和行为。
2. **字段**：表单中的输入元素，如文本框、复选框、下拉列表等。
3. **小部件**：控制表单字段在HTML中的渲染方式。
4. **验证器**：验证用户输入是否符合要求。

### 表单类型

Django提供了两种主要的表单类型：

1. **Form**：基本表单类，用于处理与模型无关的表单。
2. **ModelForm**：与模型关联的表单类，自动从模型生成表单字段。

### 基本表单

基本表单是通过继承`django.forms.Form`类创建的：

```python
from django import forms

class ContactForm(forms.Form):
    name = forms.CharField(max_length=100, label="姓名")
    email = forms.EmailField(label="邮箱")
    subject = forms.CharField(max_length=200, label="主题")
    message = forms.CharField(widget=forms.Textarea, label="消息")
    cc_myself = forms.BooleanField(required=False, label="抄送给我自己")
```

### 模型表单

模型表单是通过继承`django.forms.ModelForm`类创建的，它自动从模型生成表单字段：

```python
from django import forms
from .models import Article

class ArticleForm(forms.ModelForm):
    class Meta:
        model = Article
        fields = ["title", "content", "category", "tags"]
        # 或者使用 exclude 排除不需要的字段
        # exclude = ["author", "created_at", "updated_at"]
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "content": forms.Textarea(attrs={"class": "form-control", "rows": 10}),
        }
        labels = {
            "title": "标题",
            "content": "内容",
        }
        help_texts = {
            "tags": "多个标签请用逗号分隔",
        }
        error_messages = {
            "title": {
                "required": "请输入标题",
                "max_length": "标题不能超过200个字符",
            },
        }
```

### 表单字段

Django提供了丰富的表单字段类型，用于处理不同类型的用户输入：

1. **字符串字段**：
   - `CharField`：文本输入
   - `EmailField`：电子邮件地址
   - `URLField`：URL地址
   - `SlugField`：URL友好的字符串
   - `RegexField`：匹配正则表达式的字符串

2. **数值字段**：
   - `IntegerField`：整数
   - `FloatField`：浮点数
   - `DecimalField`：固定精度的十进制数

3. **日期时间字段**：
   - `DateField`：日期
   - `TimeField`：时间
   - `DateTimeField`：日期和时间
   - `DurationField`：时间间隔

4. **选择字段**：
   - `ChoiceField`：单选
   - `MultipleChoiceField`：多选
   - `ModelChoiceField`：从模型中选择单个对象
   - `ModelMultipleChoiceField`：从模型中选择多个对象

5. **文件字段**：
   - `FileField`：文件上传
   - `ImageField`：图片上传

6. **布尔字段**：
   - `BooleanField`：布尔值（True/False）
   - `NullBooleanField`：可为空的布尔值

### 表单小部件

小部件控制表单字段在HTML中的渲染方式：

```python
from django import forms

class ExampleForm(forms.Form):
    # 文本输入
    name = forms.CharField(widget=forms.TextInput(attrs={"class": "form-control"}))
    
    # 密码输入
    password = forms.CharField(widget=forms.PasswordInput(attrs={"class": "form-control"}))
    
    # 文本区域
    description = forms.CharField(widget=forms.Textarea(attrs={"class": "form-control", "rows": 5}))
    
    # 复选框
    is_active = forms.BooleanField(widget=forms.CheckboxInput(attrs={"class": "form-check-input"}))
    
    # 单选按钮
    gender = forms.ChoiceField(
        choices=[("M", "男"), ("F", "女")],
        widget=forms.RadioSelect(attrs={"class": "form-check-input"})
    )
    
    # 下拉列表
    country = forms.ChoiceField(
        choices=[("CN", "中国"), ("US", "美国"), ("JP", "日本")],
        widget=forms.Select(attrs={"class": "form-select"})
    )
    
    # 多选下拉列表
    languages = forms.MultipleChoiceField(
        choices=[("zh", "中文"), ("en", "英文"), ("ja", "日文")],
        widget=forms.SelectMultiple(attrs={"class": "form-select"})
    )
    
    # 日期选择器
    birth_date = forms.DateField(widget=forms.DateInput(attrs={"type": "date", "class": "form-control"}))
    
    # 文件上传
    avatar = forms.FileField(widget=forms.FileInput(attrs={"class": "form-control"}))
```

### 表单验证

Django表单系统提供了多层次的验证机制：

1. **字段级验证**：每个字段类型都有内置的验证逻辑。
2. **表单级验证**：通过`clean()`方法实现跨字段验证。
3. **自定义验证器**：可以定义和使用自定义验证函数。

```python
from django import forms
from django.core.validators import RegexValidator

class RegistrationForm(forms.Form):
    username = forms.CharField(
        min_length=3,
        max_length=20,
        validators=[RegexValidator(r'^[a-zA-Z0-9_]+$', '用户名只能包含字母、数字和下划线')]
    )
    password = forms.CharField(widget=forms.PasswordInput, min_length=8)
    confirm_password = forms.CharField(widget=forms.PasswordInput)
    email = forms.EmailField()
    
    # 字段级验证
    def clean_username(self):
        username = self.cleaned_data.get("username")
        # 检查用户名是否已存在
        if User.objects.filter(username=username).exists():
            raise forms.ValidationError("该用户名已被使用")
        return username
    
    # 表单级验证
    def clean(self):
        cleaned_data = super().clean()
        password = cleaned_data.get("password")
        confirm_password = cleaned_data.get("confirm_password")
        
        if password and confirm_password and password != confirm_password:
            self.add_error("confirm_password", "两次输入的密码不一致")
        
        return cleaned_data
```

## 案例

### 基本表单处理

```python
# forms.py
from django import forms

class ContactForm(forms.Form):
    name = forms.CharField(max_length=100, label="姓名")
    email = forms.EmailField(label="邮箱")
    subject = forms.CharField(max_length=200, label="主题")
    message = forms.CharField(widget=forms.Textarea, label="消息")
    cc_myself = forms.BooleanField(required=False, label="抄送给我自己")

# views.py
from django.shortcuts import render, redirect
from django.core.mail import send_mail
from .forms import ContactForm

def contact_view(request):
    if request.method == "POST":
        form = ContactForm(request.POST)
        if form.is_valid():
            # 获取表单数据
            name = form.cleaned_data["name"]
            email = form.cleaned_data["email"]
            subject = form.cleaned_data["subject"]
            message = form.cleaned_data["message"]
            cc_myself = form.cleaned_data["cc_myself"]
            
            # 处理表单数据
            recipients = ["admin@example.com"]
            if cc_myself:
                recipients.append(email)
            
            send_mail(
                subject=f"联系表单: {subject}",
                message=f"发件人: {name} <{email}>\n\n{message}",
                from_email="webmaster@example.com",
                recipient_list=recipients,
            )
            
            # 重定向到成功页面
            return redirect("contact_success")
    else:
        form = ContactForm()
    
    return render(request, "contact.html", {"form": form})

def contact_success_view(request):
    return render(request, "contact_success.html")
```

```html
<!-- templates/contact.html -->
{% extends "base.html" %}

{% block title %}联系我们{% endblock %}

{% block content %}
    <h1>联系我们</h1>
    
    <form method="post" novalidate>
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        {% for field in form %}
            <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in field.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
            </div>
        {% endfor %}
        
        <button type="submit" class="btn btn-primary">发送</button>
    </form>
{% endblock %}
```

### 模型表单处理

```python
# forms.py
from django import forms
from .models import Article

class ArticleForm(forms.ModelForm):
    class Meta:
        model = Article
        fields = ["title", "content", "category", "tags", "status"]
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "content": forms.Textarea(attrs={"class": "form-control", "rows": 10}),
            "category": forms.Select(attrs={"class": "form-select"}),
            "tags": forms.SelectMultiple(attrs={"class": "form-select"}),
            "status": forms.Select(attrs={"class": "form-select"}),
        }

# views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from .models import Article
from .forms import ArticleForm

@login_required
def article_create(request):
    if request.method == "POST":
        form = ArticleForm(request.POST, request.FILES)
        if form.is_valid():
            article = form.save(commit=False)
            article.author = request.user
            article.save()
            # 对于多对多字段，需要在保存对象后调用save_m2m()
            form.save_m2m()
            return redirect("article_detail", pk=article.pk)
    else:
        form = ArticleForm()
    
    return render(request, "article_form.html", {"form": form})

@login_required
def article_update(request, pk):
    article = get_object_or_404(Article, pk=pk, author=request.user)
    
    if request.method == "POST":
        form = ArticleForm(request.POST, request.FILES, instance=article)
        if form.is_valid():
            article = form.save()
            return redirect("article_detail", pk=article.pk)
    else:
        form = ArticleForm(instance=article)
    
    return render(request, "article_form.html", {"form": form, "article": article})
```

```html
<!-- templates/article_form.html -->
{% extends "base.html" %}

{% block title %}{% if article %}编辑文章{% else %}发布新文章{% endif %}{% endblock %}

{% block content %}
    <h1>{% if article %}编辑文章{% else %}发布新文章{% endif %}</h1>
    
    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="mb-3">
            {{ form.title.label_tag }}
            {{ form.title }}
            {% if form.title.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.title.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.category.label_tag }}
            {{ form.category }}
            {% if form.category.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.category.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.content.label_tag }}
            {{ form.content }}
            {% if form.content.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.content.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            {{ form.tags.label_tag }}
            {{ form.tags }}
            {% if form.tags.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.tags.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            <div class="form-text">多个标签请用逗号分隔</div>
        </div>
        
        <div class="mb-3">
            {{ form.status.label_tag }}
            {{ form.status }}
            {% if form.status.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.status.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">保存</button>
            <a href="{% url 'article_list' %}" class="btn btn-secondary">取消</a>
        </div>
    </form>
{% endblock %}
```

### 表单集处理

表单集（Formset）用于处理同一类型的多个表单：

```python
# forms.py
from django import forms
from django.forms import formset_factory, modelformset_factory, inlineformset_factory
from .models import Article, Image

class ImageForm(forms.ModelForm):
    class Meta:
        model = Image
        fields = ["title", "image"]
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "image": forms.FileInput(attrs={"class": "form-control"}),
        }

# 创建内联表单集，用于在文章表单中添加多个图片
ImageFormSet = inlineformset_factory(
    Article,
    Image,
    form=ImageForm,
    extra=3,  # 额外的空表单数量
    can_delete=True,  # 允许删除
)

# views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from .models import Article
from .forms import ArticleForm, ImageFormSet

@login_required
def article_update(request, pk):
    article = get_object_or_404(Article, pk=pk, author=request.user)
    
    if request.method == "POST":
        form = ArticleForm(request.POST, request.FILES, instance=article)
        formset = ImageFormSet(request.POST, request.FILES, instance=article)
        
        if form.is_valid() and formset.is_valid():
            article = form.save()
            formset.save()
            return redirect("article_detail", pk=article.pk)
    else:
        form = ArticleForm(instance=article)
        formset = ImageFormSet(instance=article)
    
    return render(request, "article_form.html", {
        "form": form,
        "formset": formset,
        "article": article
    })
```

```html
<!-- templates/article_form.html (添加表单集部分) -->
<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    
    <!-- 文章表单字段 -->
    <!-- ... -->
    
    <h3>文章图片</h3>
    {{ formset.management_form }}
    
    <div class="image-formset">
        {% for image_form in formset %}
            <div class="image-form mb-3 p-3 border rounded">
                {{ image_form.id }}
                
                <div class="mb-2">
                    {{ image_form.title.label_tag }}
                    {{ image_form.title }}
                    {% if image_form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in image_form.title.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-2">
                    {{ image_form.image.label_tag }}
                    {{ image_form.image }}
                    {% if image_form.image.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in image_form.image.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                {% if image_form.instance.pk %}
                    <div class="mb-2">
                        <img src="{{ image_form.instance.image.url }}" alt="{{ image_form.instance.title }}" class="img-thumbnail" style="max-height: 100px;">
                    </div>
                {% endif %}
                
                <div class="mb-2">
                    {{ image_form.DELETE }}
                    <label for="{{ image_form.DELETE.id_for_label }}">删除此图片</label>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">保存</button>
        <a href="{% url 'article_list' %}" class="btn btn-secondary">取消</a>
    </div>
</form>
```

## 总结

1. **Django的表单系统提供了强大的表单处理功能**，包括表单生成、数据验证、错误处理等，大大简化了表单处理的复杂性。

2. **Form类用于处理与模型无关的表单**，适合处理如联系表单、搜索表单等不需要直接映射到数据库模型的场景。

3. **ModelForm类与模型关联**，自动从模型生成表单字段，适合处理如创建、编辑数据库记录等场景，减少了重复代码。

4. **表单验证机制提供了多层次的验证**，包括字段级验证、表单级验证和自定义验证器，确保用户输入的数据符合要求。

5. **表单小部件控制表单字段在HTML中的渲染方式**，可以自定义表单的外观和行为，提升用户体验。

6. **表单集用于处理同一类型的多个表单**，如在一个页面中添加多个相关记录，提高了数据输入的效率。

通过本节课，我们深入了解了Django的表单系统，包括表单类型、字段、小部件、验证和处理等核心概念。这些知识将帮助我们高效地处理用户输入，构建交互性强、用户友好的Web应用程序。下一节将介绍Django的认证系统，进一步探讨如何实现用户注册、登录和权限控制。