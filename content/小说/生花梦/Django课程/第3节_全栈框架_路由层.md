       # 第3节：全栈框架_路由层

## 来源

路由层是Web框架中负责将用户请求映射到相应处理函数的关键组件。在Django中，路由系统被称为URLconf（URL配置），它定义了URL模式与视图函数之间的映射关系。Django的路由系统设计灵活而强大，支持正则表达式匹配、路径转换器、命名URL模式等高级功能，使开发者能够构建清晰、可维护的URL结构。

## 定义

### 路由层的概念

路由层是Web应用程序中负责解析HTTP请求URL并将其导向适当处理函数的组件。在Django中，路由层由以下部分组成：

1. **URLconf**：URL配置文件，通常是项目和应用中的`urls.py`文件。
2. **URL模式**：定义URL的结构和匹配规则。
3. **视图映射**：将匹配的URL连接到处理请求的视图函数或类。

### 路由中配置参数的方法

Django路由系统支持从URL中提取参数并传递给视图函数：

1. **路径转换器**：使用`<type:name>`语法从URL中捕获参数。
   - `str`：匹配除了`/`之外的任何非空字符串（默认类型）
   - `int`：匹配正整数
   - `slug`：匹配由ASCII字母、数字、连字符或下划线组成的字符串
   - `uuid`：匹配格式化的UUID
   - `path`：匹配包含`/`的非空字符串

2. **正则表达式**：使用`re_path()`函数和正则表达式模式捕获更复杂的参数。

### 路由分组和命名空间

Django支持将URL模式组织成层次结构，便于管理大型项目中的URL：

1. **include函数**：将请求分发到应用级URLconf。
   ```python
   path('blog/', include('blog.urls'))
   ```

2. **应用命名空间**：使用`app_name`变量为应用中的URL模式定义命名空间。
   ```python
   # blog/urls.py
   app_name = 'blog'
   urlpatterns = [...]
   ```

3. **实例命名空间**：在`include()`函数中指定命名空间，用于区分同一应用的多个实例。
   ```python
   path('blog/', include('blog.urls', namespace='blog'))
   ```

### 解析函数的用法

Django提供了几个函数来处理URL解析和生成：

1. **reverse()**：根据URL名称和参数生成完整的URL路径。
   ```python
   from django.urls import reverse
   url = reverse('blog:post_detail', args=[post.id])
   ```

2. **resolve()**：将URL路径解析为匹配的视图函数和参数。
   ```python
   from django.urls import resolve
   match = resolve('/blog/post/1/')
   view_func = match.func
   ```

## 案例

### 基本URL配置

```python
# mysite/urls.py
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('blog/', include('blog.urls')),
    path('', include('pages.urls')),
]
```

### 应用级URL配置

```python
# blog/urls.py
from django.urls import path
from . import views

app_name = 'blog'  # 设置应用命名空间

urlpatterns = [
    path('', views.post_list, name='post_list'),
    path('post/<int:pk>/', views.post_detail, name='post_detail'),
    path('post/new/', views.post_new, name='post_new'),
    path('post/<int:pk>/edit/', views.post_edit, name='post_edit'),
    path('category/<slug:category_slug>/', views.category_posts, name='category_posts'),
]
```

### 使用正则表达式的URL配置

```python
# blog/urls.py
from django.urls import path, re_path
from . import views

app_name = 'blog'

urlpatterns = [
    path('', views.post_list, name='post_list'),
    re_path(r'^post/(?P<year>\d{4})/(?P<month>\d{2})/(?P<slug>[\w-]+)/$', 
            views.post_detail_by_date, name='post_detail_by_date'),
]
```

### 视图函数接收URL参数

```python
# blog/views.py
from django.shortcuts import render, get_object_or_404
from .models import Post, Category

def post_detail(request, pk):
    post = get_object_or_404(Post, pk=pk)
    return render(request, 'blog/post_detail.html', {'post': post})

def category_posts(request, category_slug):
    category = get_object_or_404(Category, slug=category_slug)
    posts = Post.objects.filter(category=category)
    return render(request, 'blog/category_posts.html', {
        'category': category,
        'posts': posts
    })

def post_detail_by_date(request, year, month, slug):
    post = get_object_or_404(
        Post,
        slug=slug,
        published_date__year=int(year),
        published_date__month=int(month)
    )
    return render(request, 'blog/post_detail.html', {'post': post})
```

### 在模板中使用URL反向解析

```html
<!-- blog/post_list.html -->
{% for post in posts %}
    <h2>
        <a href="{% url 'blog:post_detail' pk=post.pk %}">{{ post.title }}</a>
    </h2>
    <p>{{ post.content|truncatewords:30 }}</p>
    <p>
        <a href="{% url 'blog:post_edit' pk=post.pk %}">编辑</a>
        <a href="{% url 'blog:category_posts' category_slug=post.category.slug %}">
            {{ post.category.name }}
        </a>
    </p>
{% endfor %}
```

### 在视图中使用URL反向解析

```python
# blog/views.py
from django.shortcuts import redirect
from django.urls import reverse

def post_new(request):
    if request.method == "POST":
        form = PostForm(request.POST)
        if form.is_valid():
            post = form.save(commit=False)
            post.author = request.user
            post.save()
            # 使用reverse()生成URL并重定向
            return redirect(reverse('blog:post_detail', args=[post.pk]))
    else:
        form = PostForm()
    return render(request, 'blog/post_edit.html', {'form': form})
```

## 总结

1. **Django的路由层提供了灵活的URL配置系统**，支持路径转换器、正则表达式、参数捕获等功能，使开发者能够设计清晰、语义化的URL结构。

2. **URL命名和命名空间机制**使得在模板和视图中引用URL变得简单可靠，即使URL模式发生变化，只要名称保持不变，应用程序的链接就不会失效。

3. **路由分组和include函数**支持将URL配置模块化，便于管理大型项目中的URL结构，提高代码的可维护性。

4. **URL反向解析**（通过`reverse()`函数或模板中的`{% url %}`标签）是Django的一个强大特性，它避免了在代码中硬编码URL，使应用程序更加灵活和可维护。

5. **路由层是连接用户请求和应用逻辑的桥梁**，掌握路由配置是开发Django应用的基础技能。

通过本节课，我们深入了解了Django的路由层，包括URL配置、参数捕获、命名空间和URL反向解析等核心概念。这些知识将帮助我们构建结构清晰、易于维护的Web应用程序。下一节将介绍Django的路由层2，进一步探讨路由的高级用法和最佳实践。