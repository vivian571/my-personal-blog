---
title: "第13节_JS逆向"
slug: "第13节_JS逆向"
date: "2025-04-24T02:48:37.642710+00:00"
---

# 第13节：JS逆向
## 学习目标

- **<font color="red">理解JavaScript逆向工程的基本概念和应用场景</font>**
- **<font color="blue">掌握浏览器开发者工具的使用方法</font>**
- **<font color="green">学习分析网站加密参数和签名的技巧</font>**
- **<font color="purple">掌握JS代码调试和断点设置方法</font>**
- **<font color="orange">了解常见的JS混淆和加密技术</font>**

## 语法

### 浏览器开发者工具

- **<font color="red">打开开发者工具</font>**：
  ```
  F12 或 Ctrl+Shift+I (Windows)
  Command+Option+I (Mac)
  ```

- **<font color="blue">网络监控</font>**：
  ```
  Network面板 - 查看所有网络请求
  Filter - 筛选特定类型请求
  Preserve log - 保留页面跳转日志
  ```

- **<font color="green">JavaScript调试</font>**：
  ```
  Sources面板 - 查看和调试JS代码
  Breakpoints - 设置断点
  Watch - 监视变量值
  Call Stack - 查看调用栈
  ```

### JS逆向分析方法

- **<font color="red">请求分析法</font>**：
  ```
  1. 定位关键请求
  2. 分析请求参数
  3. 查找参数生成位置
  4. 提取生成算法
  ```

- **<font color="blue">Hook方法</font>**：
  ```javascript
  // 重写XMLHttpRequest
  var originalXHR = window.XMLHttpRequest;
  window.XMLHttpRequest = function() {
      var xhr = new originalXHR();
      var originalOpen = xhr.open;
      xhr.open = function() {
          console.log('XHR请求：', arguments);
          return originalOpen.apply(this, arguments);
      }
      return xhr;
  };
  
  // 重写Fetch
  var originalFetch = window.fetch;
  window.fetch = function() {
      console.log('Fetch请求：', arguments);
      return originalFetch.apply(this, arguments);
  };
  ```

- **<font color="green">断点调试法</font>**：
  ```
  1. 事件监听断点 - 监听点击、表单提交等事件
  2. XHR/Fetch断点 - 监听网络请求
  3. DOM断点 - 监听DOM元素变化
  4. 条件断点 - 设置条件表达式
  ```

### 常见加密算法识别

- **<font color="red">MD5加密</font>**：
  ```javascript
  // 特征：32位16进制字符串
  // 常见函数名：md5, MD5, hex_md5
  
  // Python实现
  import hashlib
  
  def md5_encrypt(text):
      return hashlib.md5(text.encode()).hexdigest()
  ```

- **<font color="blue">Base64编码</font>**：
  ```javascript
  // 特征：字符串由A-Z, a-z, 0-9, +, /组成，可能以=结尾
  // 常见函数名：btoa, atob, Base64.encode
  
  // Python实现
  import base64
  
  def base64_encode(text):
      return base64.b64encode(text.encode()).decode()
  
  def base64_decode(text):
      return base64.b64decode(text).decode()
  ```

- **<font color="green">AES加密</font>**：
  ```javascript
  // 特征：需要密钥和IV，结果通常为Base64或Hex格式
  // 常见函数名：AES.encrypt, CryptoJS.AES
  
  // Python实现
  from Crypto.Cipher import AES
  from Crypto.Util.Padding import pad, unpad
  import base64
  
  def aes_encrypt(text, key, iv):
      cipher = AES.new(key.encode(), AES.MODE_CBC, iv.encode())
      padded_data = pad(text.encode(), AES.block_size)
      encrypted = cipher.encrypt(padded_data)
      return base64.b64encode(encrypted).decode()
  ```

## 典型示例

### 分析加密参数

```python
# 示例：分析某网站的加密签名参数
import requests
import time
import hashlib

# 1. 通过分析发现签名算法为：md5(timestamp + "salt" + mobile)
def generate_sign(mobile):
    timestamp = str(int(time.time()))
    salt = "a1b2c3d4e5f6g7h8"
    sign_str = timestamp + salt + mobile
    sign = hashlib.md5(sign_str.encode()).hexdigest()
    return timestamp, sign

# 2. 构造请求
def get_user_info(mobile):
    timestamp, sign = generate_sign(mobile)
    
    url = "https://example.com/api/user/info"
    params = {
        "mobile": mobile,
        "timestamp": timestamp,
        "sign": sign
    }
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/91.0.4472.124 Safari/537.36"
    }
    
    response = requests.get(url, params=params, headers=headers)
    return response.json()

# 3. 使用函数获取用户信息
result = get_user_info("13800138000")
print(result)
```

### 使用Python执行JS代码

```python
# 示例：使用PyExecJS执行JavaScript代码
import execjs
import requests

# 1. 提取网站中的加密函数
js_code = """
function encrypt(text, key) {
    // 这里是从网站提取的加密算法
    var result = '';
    for (var i = 0; i < text.length; i++) {
        var charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
        result += String.fromCharCode(charCode);
    }
    return btoa(result); // Base64编码
}
"""

# 2. 使用execjs执行JS代码
def get_encrypted_data(text, key):
    ctx = execjs.compile(js_code)
    return ctx.call("encrypt", text, key)

# 3. 构造请求
def send_request(data):
    encrypted_data = get_encrypted_data(data, "secretKey123")
    
    url = "https://example.com/api/submit"
    payload = {
        "data": encrypted_data
    }
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/91.0.4472.124 Safari/537.36",
        "Content-Type": "application/json"
    }
    
    response = requests.post(url, json=payload, headers=headers)
    return response.json()

# 4. 发送请求
result = send_request('{"username":"test","action":"login"}')
print(result)
```

## 实际示例

### 某电商网站商品价格获取

```python
import requests
import execjs
import json

# 1. 分析发现价格数据通过特定算法加密
js_code = """
function decryptPrice(encrypted, productId) {
    // 从网站分析得到的解密算法
    var key = productId.substring(0, 8);
    var bytes = atob(encrypted);
    var result = '';
    for (var i = 0; i < bytes.length; i++) {
        var charCode = bytes.charCodeAt(i) ^ key.charCodeAt(i % key.length);
        result += String.fromCharCode(charCode);
    }
    return result;
}
"""

# 2. 创建解密函数
def decrypt_price(encrypted_price, product_id):
    ctx = execjs.compile(js_code)
    return ctx.call("decryptPrice", encrypted_price, product_id)

# 3. 获取商品信息
def get_product_info(product_id):
    url = f"https://example.com/api/product/{product_id}"
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/91.0.4472.124 Safari/537.36",
        "Referer": f"https://example.com/product/{product_id}.html"
    }
    
    response = requests.get(url, headers=headers)
    data = response.json()
    
    # 4. 解密价格
    if "encryptedPrice" in data:
        data["price"] = decrypt_price(data["encryptedPrice"], product_id)
        del data["encryptedPrice"]
    
    return data

# 5. 获取多个商品信息
product_ids = ["P12345678", "P87654321", "P13579246"]
results = []

for product_id in product_ids:
    product_info = get_product_info(product_id)
    results.append(product_info)

# 6. 保存结果
with open("product_prices.json", "w", encoding="utf-8") as f:
    json.dump(results, f, ensure_ascii=False, indent=2)

print(f"已获取{len(results)}个商品的价格信息")
```

## 思考

1. **<font color="red">如何识别网站使用的加密算法？</font>**
   - 分析加密结果的特征（长度、字符集）
   - 查找关键函数名（md5、sha1、AES等）
   - 分析加密前后的数据变化规律

2. **<font color="blue">为什么有些网站的加密参数会定期变化？</font>**
   - 增加逆向难度
   - 防止批量爬取
   - 提高安全性

3. **<font color="green">如何应对复杂的前端混淆？</font>**
   - 使用格式化工具（如js-beautify）
   - 通过断点调试跟踪执行流程
   - 提取核心算法，忽略干扰代码

## 知识点

- **<font color="red">JS逆向的基本流程</font>**：
  - 定位关键请求
  - 分析请求参数
  - 查找参数生成位置
  - 提取生成算法
  - 用Python实现

- **<font color="blue">常见的加密和编码方式</font>**：
  - 哈希算法：MD5、SHA1、SHA256
  - 对称加密：AES、DES
  - 非对称加密：RSA
  - 编码方式：Base64、URL编码、Unicode编码

- **<font color="green">调试工具的使用</font>**：
  - 浏览器开发者工具
  - 断点调试技巧
  - 变量监视
  - 网络请求分析

- **<font color="purple">Python执行JS代码的方法</font>**：
  - PyExecJS
  - Js2Py
  - Node.js子进程调用

## 小结

- JS逆向是爬虫绕过前端加密的重要技术
- 掌握浏览器开发者工具是逆向分析的基础
- 常见加密算法识别和实现是核心能力
- Python与JavaScript结合使用可以高效实现爬虫
- 持续学习和实践是提高逆向能力的关键

## 总结

本节介绍了JS逆向工程在爬虫中的应用，包括浏览器开发者工具的使用、JS代码分析方法、常见加密算法识别和Python实现等内容。通过实际案例展示了如何分析网站的加密参数并用Python实现相应的算法，帮助读者掌握应对复杂网站的爬取技巧。JS逆向是高级爬虫必备的技能，需要不断实践和积累经验。